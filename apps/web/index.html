<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MinhaIALAST</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">
  <div class="max-w-5xl mx-auto p-4">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-xl font-semibold">MinhaIALAST</h1>
      <div class="text-xs text-zinc-400"><span id="apiStatus">API: verificando...</span></div>
    </div>

    <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 bg-zinc-900/40 border border-zinc-800 rounded-2xl p-4">
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium">Perfil</span>
          <select id="profile" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2 text-sm w-full"></select>
        </div>

        <div class="mt-3">
          <label class="block text-xs text-zinc-400">Prompt / Texto</label>
          <textarea id="prompt" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-sm" rows="4" placeholder="Ex: Teste de vídeo"></textarea>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-zinc-400">Aspect</label>
            <select id="aspect" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm">
              <option value="16:9">16:9</option>
              <option value="9:16">9:16</option>
              <option value="1:1">1:1</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-zinc-400">FPS</label>
            <input id="fps" type="number" min="1" max="60" value="24" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm"/>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-zinc-400">Duração (s)</label>
            <input id="duration" type="number" min="1" max="60" value="3" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm"/>
          </div>
          <div>
            <label class="block text-xs text-zinc-400">Speed (somente modo Speed)</label>
            <input id="speed" type="number" step="0.05" min="0.25" max="4" value="1.25" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm"/>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-zinc-400">Upload (vídeo/imagem/áudio/srt)</label>
            <input id="upload" type="file" class="w-full text-sm"/>
          </div>
          <div>
            <label class="block text-xs text-zinc-400">Inputs (paths do upload)</label>
            <input id="inputs" type="text" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm" placeholder="Ex: storage/uploads/abc.mp4, storage/uploads/def.mp3"/>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="run" class="bg-white text-black px-4 py-2 rounded-xl text-sm font-medium">Rodar</button>
          <button id="refreshJobs" class="bg-zinc-800 px-4 py-2 rounded-xl text-sm">Atualizar Jobs</button>
        </div>

        <div class="mt-4 text-xs text-zinc-400" id="msg"></div>
      </div>

      <div class="bg-zinc-900/40 border border-zinc-800 rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm font-medium">Jobs</div>
          <a class="text-xs underline text-zinc-300" href="/docs" target="_blank">API Docs</a>
        </div>
        <div id="jobs" class="mt-3 space-y-3 text-sm"></div>

        <div class="mt-6 border-t border-zinc-800 pt-4">
          <div class="text-sm font-medium">Assets</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <input id="cdcPid" type="number" class="bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm" placeholder="PHIL pid (ex 17418)"/>
            <button id="importCdc" class="bg-zinc-800 px-3 py-2 rounded-xl text-sm">Importar CDC</button>
          </div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <input id="commonsCat" type="text" class="bg-zinc-950 border border-zinc-800 rounded-xl p-2 text-sm" placeholder="Commons categoria"/>
            <button id="importCommons" class="bg-zinc-800 px-3 py-2 rounded-xl text-sm">Importar Commons</button>
          </div>
          <button id="refreshAssets" class="mt-2 bg-zinc-800 px-3 py-2 rounded-xl text-sm w-full">Listar Assets</button>
          <div id="assets" class="mt-3 space-y-2 text-xs text-zinc-300"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const el = (id) => document.getElementById(id);

async function apiCheck(){
  try{
    const r = await fetch("/health");
    const j = await r.json();
    el("apiStatus").textContent = "API: OK (" + j.time + ")";
  }catch(e){
    el("apiStatus").textContent = "API: OFF (ver scripts\\logs.cmd)";
  }
}

function flattenProfiles(p){
  const out = [];
  for(const g of (p.groups||[])){
    for(const pr of (g.profiles||[])){
      out.push({group:g.name, ...pr});
    }
  }
  return out;
}

async function loadProfiles(){
  const r = await fetch("/config/profiles.json");
  const j = await r.json();
  const list = flattenProfiles(j);
  const sel = el("profile");
  sel.innerHTML = "";
  for(const p of list){
    const opt = document.createElement("option");
    opt.value = p.modes[0];
    opt.textContent = p.group + " — " + p.name + " (" + p.modes[0] + ")";
    sel.appendChild(opt);
  }
}

async function uploadFile(){
  const f = el("upload").files[0];
  if(!f) return null;
  const fd = new FormData();
  fd.append("file", f);
  const r = await fetch("/upload", {method:"POST", body: fd});
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}

async function refreshJobs(){
  const r = await fetch("/jobs?limit=20");
  const j = await r.json();
  const root = el("jobs");
  root.innerHTML = "";
  for(const item of (j.items||[])){
    const div = document.createElement("div");
    div.className = "border border-zinc-800 rounded-xl p-3 bg-zinc-950/40";
    const out = item.outputs && item.outputs.final ? `<a class="underline" href="${item.outputs.final}" target="_blank">Baixar final.mp4</a>` : "";
    const err = item.error ? `<div class="mt-2 text-red-300 text-xs">${item.error}</div>` : "";
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-xs text-zinc-400">${item.id}</div>
        <div class="text-xs">${item.status}</div>
      </div>
      <div class="mt-1 text-xs text-zinc-300">${out}</div>
      ${err}
    `;
    root.appendChild(div);
  }
}

async function runJob(){
  el("msg").textContent = "";
  let uploaded = null;
  try{ uploaded = await uploadFile(); } catch(e) {}
  const mode = el("profile").value;
  let inputs = (el("inputs").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  if(uploaded && uploaded.path && inputs.length === 0) inputs = [uploaded.path];

  const body = {
    profile_id: mode,
    mode: mode,
    prompt_or_script: el("prompt").value||"",
    inputs: inputs,
    params: {
      duration: parseFloat(el("duration").value||"3"),
      fps: parseInt(el("fps").value||"24",10),
      aspect: el("aspect").value,
      speed: parseFloat(el("speed").value||"1.25"),
    }
  };
  const r = await fetch("/jobs", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
  const j = await r.json();
  el("msg").textContent = "Job criado: " + j.id + " (aguarde alguns segundos e clique Atualizar Jobs)";
  await new Promise(res => setTimeout(res, 1200));
  await refreshJobs();
}

async function refreshAssets(){
  const r = await fetch("/assets?limit=50");
  const j = await r.json();
  const root = el("assets");
  root.innerHTML = "";
  for(const a of (j.items||[])){
    const url = `/assets/file/${a.id}`;
    const div = document.createElement("div");
    div.className = "border border-zinc-800 rounded-xl p-2 bg-zinc-950/40";
    div.innerHTML = `
      <div class="text-xs font-medium">${a.title || a.source_id}</div>
      <div class="opacity-80">${a.license || ""}</div>
      <a class="underline" href="${url}" target="_blank">Abrir arquivo</a>
    `;
    root.appendChild(div);
  }
}

async function importCdc(){
  const pid = parseInt(el("cdcPid").value||"0",10);
  if(!pid) return;
  const r = await fetch("/assets/import/cdc_phil", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({pid})});
  if(!r.ok){ el("msg").textContent = await r.text(); return; }
  el("msg").textContent = "Importado CDC pid=" + pid;
  await refreshAssets();
}

async function importCommons(){
  const category = (el("commonsCat").value||"").trim();
  if(!category) return;
  const r = await fetch("/assets/import/commons_category", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({category, limit: 20})});
  if(!r.ok){ el("msg").textContent = await r.text(); return; }
  const j = await r.json();
  el("msg").textContent = "Importados: " + j.imported + " (" + j.category + ")";
  await refreshAssets();
}

el("run").addEventListener("click", runJob);
el("refreshJobs").addEventListener("click", refreshJobs);
el("refreshAssets").addEventListener("click", refreshAssets);
el("importCdc").addEventListener("click", importCdc);
el("importCommons").addEventListener("click", importCommons);

apiCheck();
loadProfiles().then(refreshJobs);
</script>
</body>
</html>
